<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2020-02-17 周一 23:09 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Architecting and Operating OpenShift Cluster</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="龔存" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2018 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Architecting and Operating OpenShift Cluster</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orga570c97">1. Networking</a>
<ul>
<li><a href="#org583cf3f">1.1. East-West Traffic</a></li>
<li><a href="#org3f23237">1.2. North-South Traffic</a></li>
</ul>
</li>
<li><a href="#orgb657aeb">2. Build &amp; deploy docker image</a>
<ul>
<li><a href="#org1163231">2.1. Setup the proxy</a></li>
<li><a href="#org827fe1f">2.2. Create docker image</a></li>
<li><a href="#orgcb5f444">2.3. Delete container &amp; images</a></li>
<li><a href="#org0093f96">2.4. Push docker images to OpenShift internal registry</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-orga570c97" class="outline-2">
<h2 id="orga570c97"><span class="section-number-2">1</span> Networking</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org583cf3f" class="outline-3">
<h3 id="org583cf3f"><span class="section-number-3">1.1</span> East-West Traffic</h3>
<div class="outline-text-3" id="text-1-1">
<p>
In the default configuration, the cluster network is the <b>10.128.0.0/14</b>
network, and node allocated <b>/23</b> subnets (i.e., <b>10.128.0.0/23</b>,
<b>10.128.2.0/23</b>, <b>10.128.4.0/23</b>, and so on). This means that the cluster
network has 512 subnets available to assign to nodes, and a given node is
allocated 510 addresses that it can assign to the containers running on it. The
size and address range of the cluster network are configurable, as is the host
subnet size. 
</p>

<pre class="example">
[root@master ~]# view /etc/origin/master/master-config.yaml
networkConfig:
  clusterNetworks:
  - cidr: 10.128.0.0/14
    hostSubnetLength: 9
  externalIPNetworkCIDRs:
  - 0.0.0.0/0
  networkPluginName: redhat/openshift-ovs-subnet
  serviceNetworkCIDR: 172.30.0.0/16

[root@master ~]# oc get hostsubnet -o wide
NAME                     HOST                     HOST IP         SUBNET          EGRESS CIDRS   EGRESS IPS
infra.myopenshift.com    infra.myopenshift.com    192.168.23.52   10.130.0.0/23   []             []
master.myopenshift.com   master.myopenshift.com   192.168.23.31   10.128.0.0/23   []             []
node.myopenshift.com     node.myopenshift.com     192.168.23.51   10.129.0.0/23   []             []
</pre>

<p>
OpenShift SDN creates and configures three network devices:
</p>

<dl class="org-dl">
<dt>br0</dt><dd>the OVS bridge device that pod containers will be attached to.
OpenShift SDN also configures a set of non-subnet-specific flow rules
on this bridge.</dd>
<dt>tun0</dt><dd>an OVS internal port (port 2 on <b>br0</b>). This gets assigned the cluster
subnet gateway address, and is used for external network access.
OpenShift SDN configures <b>netfilter</b> and routing rules to enable access
from the cluster subnet to the external network via NAT.</dd>
<dt>vxlan_sys_4789</dt><dd>The OVS VXLAN device (port 1 on <b>br0</b>), which provides access
to containers on remote nodes. Referred to as <b>vxlan0</b> in the
OVS rules.</dd>
</dl>

<p>
For each Pod in the Node, the local OpenShift creates a <i>vethXX</i> interface and
assign it to the OVS br0. The <i>vxlan_sys_4789</i> of <i>br0</i> is the interface that
defines the <i>VXLAN</i> tunnels, or the overlay network, that enables the
communication between local Pods with Pods in remote Nodes. This interface is
known as <i>vxlan0</i> interface inside the OVS and that is the name used in the
OpenFlow entries. The <i>tun0</i> interface gets the local cluster network subnet
gateway address. This is the interface that provide <i>NAT</i> access from the
cluster network subnet to the external network. In additional to the local
cluster network subnet gateway address, on each <i>Node</i> the Kubernetes Service
objects network is also pointed to the <i>tun0</i> interface.
</p>

<pre class="example">
[root@node ~]# ip route
...
10.128.0.0/14 dev tun0 scope link
...
172.30.0.0/16 dev tun0

[root@node ~]# ifconfig tun0
tun0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1450
        inet 10.129.0.1  netmask 255.255.254.0  broadcast 10.129.1.255
        ...

[root@node ~]# iptables -v -t nat -L OPENSHIFT-MASQUERADE
Chain OPENSHIFT-MASQUERADE (1 references)
 pkts bytes target     prot opt in     out     source               destination
    0     0 RETURN     all  --  any    any     anywhere             anywhere             mark match 0x1/0x1
    7   621 MASQUERADE  all  --  any    any     10.128.0.0/14        anywhere             /* masquerade pod-to-service and pod-to-external traffic */

</pre>
<p>
The Pod ip will be NAT to the IP of the physical interface when it access the
external host.
</p>
</div>
</div>
<div id="outline-container-org3f23237" class="outline-3">
<h3 id="org3f23237"><span class="section-number-3">1.2</span> North-South Traffic</h3>
<div class="outline-text-3" id="text-1-2">
<pre class="example">
[root@master ~]# oc get all --selector='router=router' -n default -o wide
NAME                 READY     STATUS    RESTARTS   AGE       IP              NODE                    NOMINATED NODE
pod/router-2-ssfwc   1/1       Running   0          17h       192.168.23.52   infra.myopenshift.com   &lt;none&gt;

NAME                             DESIRED   CURRENT   READY     AGE       CONTAINERS   IMAGES                                                       SELECTOR
replicationcontroller/router-1   0         0         0         18h       router       registry.redhat.io/openshift3/ose-haproxy-router:v3.11       deployment=router-1,deploymentconfig=router,router=router
replicationcontroller/router-2   1         1         1         17h       router       registry.redhat.io/openshift3/ose-haproxy-router:v3.11.157   deployment=router-2,deploymentconfig=router,router=router

NAME             TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                   AGE       SELECTOR
service/router   ClusterIP   172.30.169.119   &lt;none&gt;        80/TCP,443/TCP,1936/TCP   18h       router=router

NAME                                        REVISION   DESIRED   CURRENT   TRIGGERED BY
deploymentconfig.apps.openshift.io/router   2          1         1         config

</pre>

<p>
The default OpenShift Router is one or more Router Pods running on
Infrastructure Nodes (<code>infra.myopenshift.com</code>) and is deployed as a <i>Deployment
Config</i> (<code>deploymentconfig.apps.ose.I/O/router</code>).
</p>

<p>
These Routers container images are based on <i>HAProxy</i> (see <code>IMAGES</code>). These
<i>Pods</i> are defined to share the <i>Network Namespace</i> with the host
<i>Infrastructure Node</i>:
</p>
<pre class="example">
[root@master ~]# oc api-resources
[root@master ~]# oc get dc
[root@master ~]# oc get services
[root@master ~]# oc get pods
[root@master ~]# oc get routes
[root@master ~]# oc get routes &lt;route-name&gt; -o yaml
[root@master ~]# oc get dc router -o yaml
[root@master ~]# oc get services router -o yaml
[root@master ~]# oc get services &lt;service-name&gt; -o yaml
[root@master ~]# oc get pods &lt;pod-name&gt; -o yaml


</pre>

<p>
Sharing the <i>Network Namespace</i> enables these <i>Router Pods</i> to receive traffic
over the <i>host-network</i>. By default, the <i>OpenShift Router</i> listens on TCP ports
80 (HTTP), 443 (HTTPS), and 1936 (HAProxy Stats). Once the traffic arrives to
the Pod, it will match the corresponding Route object.
</p>
</div>
</div>
</div>
<div id="outline-container-orgb657aeb" class="outline-2">
<h2 id="orgb657aeb"><span class="section-number-2">2</span> Build &amp; deploy docker image</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-org1163231" class="outline-3">
<h3 id="org1163231"><span class="section-number-3">2.1</span> Setup the proxy</h3>
<div class="outline-text-3" id="text-2-1">
<div class="org-src-container">
<pre class="src src-sh">oc describe svc/docker-registry -n default
...
Type:              ClusterIP
IP:                <span style="color: #a45bad;">172.30.151.16</span>

cat ~/.docker/config.json
...
<span style="color: #2d9574;">"proxies"</span>: <span style="color: #4f97d7;">{</span>
    <span style="color: #2d9574;">"default"</span>: <span style="color: #bc6ec5;">{</span>
        <span style="color: #2d9574;">"httpProxy"</span>: <span style="color: #2d9574;">"http://proxy.myopenshift.com:8888"</span>,
        <span style="color: #2d9574;">"httpsProxy"</span>: <span style="color: #2d9574;">"http://proxy.myopenshift.com:8888"</span>,
        <span style="color: #2d9574;">"noProxy"</span>: <span style="color: #2d9574;">"*.bocmo.com,.bocmacau.com,.myopenshift.com,172.30.151.16"</span>
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>

systemctl daemon-reload
systemctl restart docker

docker login registry.redhat.io
Username:
Password:
Login Succeeded

docker pull registry.redhat.io/rhel7
docker images
registry.redhat.io/rhel7 

<span style="color: #ffd700; background-color: #292e34;"># </span><span style="color: #ffd700; background-color: #292e34;">Get the image path</span>
docker info
...
Docker Root Dir: /var/lib/docker

...

</pre>
</div>
</div>
</div>

<div id="outline-container-org827fe1f" class="outline-3">
<h3 id="org827fe1f"><span class="section-number-3">2.2</span> Create docker image</h3>
<div class="outline-text-3" id="text-2-2">
<div class="org-src-container">
<pre class="src src-sh">mkdir -p /opt/docker/test
<span style="color: #4f97d7;">cd</span> /opt/docker/test

vi Dockerfile
<span style="color: #ffd700; background-color: #292e34;"># </span><span style="color: #ffd700; background-color: #292e34;">This Dockerfile uses the rhel7 image</span>
<span style="color: #ffd700; background-color: #292e34;"># </span><span style="color: #ffd700; background-color: #292e34;">Version 1 - Edition 1</span>
<span style="color: #ffd700; background-color: #292e34;"># </span><span style="color: #ffd700; background-color: #292e34;">Ahthor: Cun Gong</span>
FROM rhel:latest
RUN date; sleep <span style="color: #a45bad;">30</span>; date
RUN echo <span style="color: #2d9574;">"Hello World"</span> &gt;/tmp/test.out
RUN date; sleep <span style="color: #a45bad;">30</span>; date
CMD /bin/sh

docker build -t rhel7:v1 .
docker ps <span style="color: #ffd700; background-color: #292e34;"># </span><span style="color: #ffd700; background-color: #292e34;">get the container-id</span>
docker exec -it &lt;container-id&gt; sh
sh-4.2# ps -ef

docker run -it rhel7:v1 cat /tmp/test.out

docker run -it rhel7:v1
sh-4.2# ls -l /tmp/test.out
-rw-r--r--. <span style="color: #a45bad;">1</span> root root <span style="color: #a45bad;">12</span> Feb <span style="color: #a45bad;">17</span> <span style="color: #a45bad;">06:23</span> /tmp/test.out

docker run -it rhel7:v1
sh-4.2# yum install -y nc
sh-4.2# nc -4kl <span style="color: #a45bad;">8080</span> -c <span style="color: #2d9574;">'/usr/bin/cat'</span> &amp;
sh-4.2# nc localhost <span style="color: #a45bad;">8888</span>

<span style="color: #ffd700; background-color: #292e34;">## </span><span style="color: #ffd700; background-color: #292e34;">Test again</span>
<span style="color: #4f97d7;">cd</span> /opt/docker/test
git init
git add ./Dockerfile
git commit -m<span style="color: #2d9574;">"first test"</span>

cat Dockerfile
<span style="color: #ffd700; background-color: #292e34;"># </span><span style="color: #ffd700; background-color: #292e34;">This Dockerfile uses the rhel7 image</span>
<span style="color: #ffd700; background-color: #292e34;"># </span><span style="color: #ffd700; background-color: #292e34;">Ahthor: Cun Gong</span>
FROM rhel7:v2
CMD <span style="color: #4f97d7;">[</span><span style="color: #2d9574;">"nc"</span>, <span style="color: #2d9574;">"-4"</span>, <span style="color: #2d9574;">"-l"</span>, <span style="color: #2d9574;">"8080"</span>, <span style="color: #2d9574;">"-c"</span>, <span style="color: #2d9574;">"/usr/bin/cat -v"</span><span style="color: #4f97d7;">]</span>

docker build -t rhel7:v3 .
<span style="color: #ffd700; background-color: #292e34;"># </span><span style="color: #ffd700; background-color: #292e34;">Server terminal</span>
docker run -it --rm -p <span style="color: #a45bad;">8080:8080</span> rhel7:v3
<span style="color: #ffd700; background-color: #292e34;"># </span><span style="color: #ffd700; background-color: #292e34;">Client terminal</span>
nc localhost <span style="color: #a45bad;">8080</span>
hello world
hello world

</pre>
</div>
</div>
</div>

<div id="outline-container-orgcb5f444" class="outline-3">
<h3 id="orgcb5f444"><span class="section-number-3">2.3</span> Delete container &amp; images</h3>
<div class="outline-text-3" id="text-2-3">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #ffd700; background-color: #292e34;"># </span><span style="color: #ffd700; background-color: #292e34;">Delete containers</span>
docker ps --all | grep rhel
docker container kill &lt;id&gt;
docker rm -v &lt;id&gt; &lt;id&gt; ...

<span style="color: #ffd700; background-color: #292e34;"># </span><span style="color: #ffd700; background-color: #292e34;">Delete images</span>
docker images
docker rmi rhel7:v2
</pre>
</div>
</div>
</div>

<div id="outline-container-org0093f96" class="outline-3">
<h3 id="org0093f96"><span class="section-number-3">2.4</span> Push docker images to OpenShift internal registry</h3>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: 龔存</p>
<p class="date">Created: 2020-02-17 周一 23:09</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
